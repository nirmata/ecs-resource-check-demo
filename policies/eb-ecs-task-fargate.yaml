apiVersion: json.kyverno.io/v1alpha1
kind: ValidatingPolicy
metadata:
  annotations:
    description.policy.kyverno.io: This Policy ensures that FARGATE clusters have container insights enabled.
    title.policy.kyverno.io: Norvatis requires FARGATE usage
  labels:
    ecs.aws.tags.kyverno.io: ecs-cluster
  name: ecs-cluster-require-fargate
spec:
  rules:
    - name: required-container-fargate
      match:
        any:
         - source: aws.ecs
         - detail-type: "AWS API Call via CloudTrail"
      assert:
        any:
          - message: ECS Cluster use of Fargate or Fargate Spot instances should be used '{{detail.taskArn}}' at '{{detail.clusterArn}}'
            check:
              detail:
                requestParameters:
                  launchType:
                    (contains(@, 'FARGATE')): true
                    (contains(@, 'FARGATE_SPOT')): true
